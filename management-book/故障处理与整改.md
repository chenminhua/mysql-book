## 故障处理

故障发生时
快速恢复最重要。而前提是快速定位故障源。
oncall 制度。
最重要的不是 debug，而是尽可能减少故障影响范围。

如何恢复系统
性能和可用性问题：重启和限流，使用流控中间件。
新代码有 bug 问题：回滚操作。
无法回滚的情况：降级操作。
紧急更新。

故障发生前
以用户功能为索引的服务和资源的全视图。
为各个服务制定关键指标，以及一套运维流程和工具，包括应急方案。
设定故障等级。
进行故障演练。
灰度发布系统。

## 故障复盘

亚马逊内部面对 s1 和 s2 的故障复盘，需要团队经理写一个 coe（correction of errors）的文档，并提交到管理层审查。文档内容包括：

- 此次故障处理的整个过程。
- 故障原因分析。
- ask 5 whys。
- 故障后续整改计划。

阿里的故障复盘会把所有相关人员叫到现场来复盘。并加入了故障等级和故障责任人。

## 复盘举例

一个慢 sql 的故障复盘：

- 为什么从故障发生到系统报警花了 27 分钟？为什么只发邮件，没有短信？
- 为什么花了 15 分钟，开发才知道是慢 sql 导致的问题？
- 为什么监控没有检测到 nginx 499 错误，以及 nginx 的 upstream_response_time 和 request_time？
- 为什么一开始按照 ddos 处理？
- 为什么要重启数据库？
- 为什么之前没有发生过？
- 为什么上首页前没有做性能测试？
- 为什么使用这个高危 sql?
- 上线过程为什么没有 dba 评审？

技术问题 -> 工程能力问题 -> 管理问题 -> 公司文化问题 -> 创始人的问题
