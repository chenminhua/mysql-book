何时需要消息队列: 业务解耦，最终一致性，广播，错峰，流控。

### 解耦

解耦不止是代码上的解耦，更是处理能力，稳定性，扩展性等角度的考虑。

比如美团旅游有个产品中心。产品中心上游对接主站、移动后台、旅游供应链等数据源。产品中心下游对接筛选系统，API 系统等展示系统。上游的数据发生变化时，肯定不希望受到产品中心稳定性和处理能力的影响，上游系统往往也不关心你产品中心更新是否成功。下游系统更新索引，刷新缓存的需求也不是产品中心要关心的，如果让产品中心通过接口去通知他们，产品中心就太重了。产品中心希望只要发一个变更消息包含产品 ID 就好了。

比如订单系统，订单支付成功可能要给用户发短信积分啥的，但是这已经不是订单系统的核心流程了。而且如果短信等外部系统比较慢，主流程一定不希望自己被 block。这时候就可以用消息系统。

### 最终一致性

举个银行转账的例子。需求很简单，若 A 系统扣钱成功，则 B 系统加钱一定成功，反之一起回滚。一种实现方案是使用分布式事务，比如两阶段提交等等。但是这种方案落地太难且成本太高。

还有一种方案是最终一致性，“记录+补偿”。首先在 A 扣钱成功的时候，记录下要去 B 加钱这件事在数据库中，用定时任务去处理 B 加钱这件事，如果失败的话可以重试。具体方案如下，**首先 A 系统可以完成自己这边的业务校验并完成数据更改，同时将事件记录在本地库，然后将消息发送给 broker，在 broker 成功 ack 后将本地消息删除，以此来确保消息一定会到达 broker。在消费者 B 确认成功消费这条消息后再将消息从 broker 移除。**

需要注意，**像 kafka 这类可能丢消息的 MQ（比如定时刷盘，掉电就会丢消息），业务须用其他方式来保证结果正确。**

### 广播

产品中心发布产品变更的消息，可能很多下游系统都关心，但产品中心只需要发布一次变更消息就可以了。

### 错峰与流控

上下游的处理能力是不同的。

### 如何设计一个消息队列

设计目标：高可用，RPC, 顺序和重复消息，可靠投递，消费关系解析。

我们之所以要设计一个消息队列，并配备 broker，无外乎做两件事：消息的转储和投递，规范一种通用的模式。

- 先 build 一个数据流，利用 RPC 将数据流串起来，并且尽量做到无状态，方便水平扩展。
- 第二步是考虑消息的堆积，而处理堆积的最佳方式就是存储。
- 第三步是要实现广播功能，我们必须维护消费关系，可以用 zk 来保存消费关系。
- 最后我们可以考虑实现一些高级特性，比如可靠投递，事务，性能优化等等。

## 参考

https://zhuanlan.zhihu.com/p/21649950
