一个监控系统需要完成：

- 全栈监控，
- 关联分析，
- 跨系统调用的串联，
- 实时报警和自动处置，
- 系统性能分析。

# 全栈监控

三层监控：基础层，中间层，应用层。

- 基础层包括监控主机和底层资源：比如 CPU，内存，网络吞吐，硬盘 IO，硬盘使用情况。
- 中间层是对中间件的监控，比如 nginx, redis, kafka, mysql 等。
- 应用层需要监控 http 访问吞吐，响应时间，返回码，调用链路，性能瓶颈等等。

监控标准化：

- 日志数据结构化，
- 监控数据格式标准化，
- 统一的监控平台，
- 统一的日志分析。

### 什么是好的监控系统

- 首先监控系统应该关注整体应用的 SLA。要抓住重点。
- 需要做关联指标的聚合。把服务和相关的中间件以及主机联系在一起，要把服务的具体实例和主机关联。
- 需要能够快速定位故障。需要对整个分布式系统做一个用户请求跟踪的 trace 监控，监控请求在系统中的调用链。
- 体检，提供全局的系统运行时数据展示，让工程师团队知道是否需要增加机器或其他资源。
- 性能管理，可以通过看大盘找到系统瓶颈，并有针对性地优化系统。
- 急诊，能快速定位问题。
- 性能分析，可以快速找到系统瓶颈。

### 好的监控系统需要什么

- 服务调用链追踪，也就是 tracing。google dapper，其对应开源实现是 zipkin。还有 pinpoint 或者 cat。
- 服务调用时长分布，这可以帮助我们看到服务调用链上最耗时的服务是什么。
- 服务的 TOP N 视图。就是一个系统请求的排名情况。可以按调用量排名，按请求耗时排名，按热点排名。
- 数据库操作相关。对应 java，可通过 javaAgent 字节码注入技术拿到 JDBC 执行数据库操作的执行时间。
- 服务资源跟踪，我们需要把服务运行的机器节点上的数据（cpu, mem, IO, network, disk）关联起来。这样当一台机器因为 CPU 或者 IO 过高挂掉的时候，我们就可以知道其会影响到哪些对外服务的 API 了。有了好的监控，我们才能快速发现资源瓶颈并进行有针对性的资源调度。

有时候一个分布式系统的服务调用链接上都在报错，其根本原因是数据库链接过多，服务不过来。另外一个原因是，Java 在做 Full GC 导致处理过慢。于是，消息队列出现消息堆积堵塞。
