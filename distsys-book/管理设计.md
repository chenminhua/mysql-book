# 边车模式 sidecar

- 不在服务中增加控制面上的东西，比如日志、监控、限流、熔断、服务注册、协议适配转换，而是将这些东西都交给边车。
- 边车像是服务的一个 agent，服务所有对外的通信都通过这个 agent。
- sidecar 需要和应用服务有一模一样的生命周期。
- sidecar 模式很适合用在对于老旧系统的升级改造中。（老代码很难改的）
- istio 就是使用了 sidecar 模式。

日志、监控、限流这些需求通常有两种方式来实现。一种是 sdk，lib 的方式集成进服务。一种是 sidecar 的方式。两者的区别在于前者是开发时集成，而后者是运维时集成。前者有利于资源的利用，性能也更好，但是对应用有侵入。后者对应用完全没有侵入，但是延时更长，也增加了管理部署的难度。

# service mesh

https://time.geekbang.org/column/article/5920

# 网关模式

Sidecar, service mesh 都是在不侵入业务的前提下，将业务和控制分离开，但是这两种方案都极大地增加了运维成本。

更为简单的架构模式是，为一组服务提供一个 gateway；甚至也可以粗到为整个集群提供一个接入的 gateway。gateway 和设计模式中的 facade 模式有点像，gateway 封装内部系统的架构并提供对外的 api。gateway 可以提供的功能：

- 请求路由
- 服务注册
- 负载均衡
- 弹力设计 （异步、重试、幂等、流控、熔断）
- 安全设计 （鉴权, session）
- api 聚合 （将多个后端服务请求聚合成一个）
- api 编排 微服务架构下，要走完一个完整的业务流程，需要调用一系列 API，就像工作流一样，这完全可以通过网页来编排这个业务流程。我们可能通过一个 DSL 来定义和编排不同的 API，也可以通过像 AWS Lambda 服务那样的方式来串联不同的 API。

### 对比 sidecar, gateway 和 service mesh 三种模式

- sidecar 适合用于改造已有的服务，可以用于干很多业务透明的活。
- 当 sidecar 越来越多的时候，我们就需要统一管理这些 sidecar，就有了 service mesh。
- 我们把所有业务无关的东西都放在 sidecar 和 controller 中。业务方只需要把服务往网格中一放就好了。
- gateway 简单一点，通过 gateway 封装后端业务，并在其上做很多控制。一般来说 gateway 更容易使用。

### 网关设计重点

- 高性能
- 高可用：集群化，服务化（可以动态修改配置），持续化（能够优雅自动重启）
- 高扩展：网关上或多或少要做一些逻辑的，可扩展性很重要
- 运维方面：要有监控，有 trace 链路跟踪。要统计好每个 api 的吞吐量和返回时间。要有弹力设计。
- 安全方面： 网关鉴权，网关要能检测异常请求。
- 整体架构：不要直接在网关上聚合后端 api, 应该把 api 聚合放在网关后面的某个服务上，也可以使用 plugin 的方式。网关要和后端在一个内网。考虑 bulkhead，比如不同的客户端用不同的网关。
