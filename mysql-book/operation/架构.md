# 组成结构

大体可以分为 server 和存储引擎两部分。

Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。
而存储引擎层负责数据的存储和提取，最常用的是 InnoDB。

### 连接器

负责建立和维持连接，校验权限。show processlist 命令中看到所有连接。参数 wait_timeout 控制的，默认 8 小时。如果超过这个时间连接上没有事件，就会被连接器断开。

建立连接的过程通常是比较复杂的，应当尽量使用长连接。但是如果长连接过多，可能导致内存占用过大。如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

### 查询缓存

拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句，如果是则直接拿缓存结果。通常不建议开启查询缓存。为什么不建议使用查询缓存：因为每当表上有更新，都有去让查询缓存失效。
MySQL

### 分析器、优化器

分析器分析 sql 的词法和语法，确定要干什么。而优化器则确定怎么干最好。优化器会分析使用哪个索引，如何 join 多个表等等。explain sql 的操作就是进行到优化器后返回执行方案。

### 执行器

优化器完成工作后，就得到了执行方案，下一步就是执行语句。不同的表使用不同的存储引擎，执行器会根据表的引擎定义，去使用这个引擎提供的接口。

你会在数据库的慢查询日志中看到一个 rows_examined 的字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此**引擎扫描行数跟 rows_examined 并不是完全相同的。**

### 存储引擎

存储引擎是基于表的

show engines --查看支持的引擎
show variables like '%storage_engine%' --当前的默认存储引擎
show table status like tablename --当前表的状态
alter table tablename engine = enginename --修改存储引擎

##### innodb

行锁，支持外键，面向事务。
数据存在一个逻辑表空间中。
使用 mvcc，实现四种隔离级别。
使用 next-key locking 来防止幻读。
提供插入缓冲，二次写。
