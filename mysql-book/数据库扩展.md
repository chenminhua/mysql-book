## 读写分离

优点：比较容易实现，master-slave 的配置和服务框架里的读写分离都比较成熟。

缺点：写库是单点。如果是强一致性的读写操作，读写还是要都落到写库上。

- Query（查）操作基本是做数据整合显示，而 Command（增删改）这边会有更重的业务逻辑。分离开这两种操作可以在语义上有更好的区分。
- Query 会返回结果，但是不改变数据，没有副作用。Command 不会返回数据，只返回执行状态，但是会改变数据。
- 分离 Query 和 Command 可以提高系统的性能、可扩展性和安全性。

## 分库分表

分库的策略：可以按照地理位置分，或者按照日期分等等。

#### 数据访问层的中间件

为了不让我们的服务感知到数据库的变化，我们需要引入“数据访问层中间件”来做路由。
这里面就有一堆麻烦事。比如跨库的分页操作，比如跨库的 max/min/count 操作，比如处理跨库的事务等等。为了避免这些麻烦，我们需要选择好的分片策略。

- 按多租户分，隔离租户。
- 按数据种类分，比如按商品类目分，或者按地域分。
- 按范围分，比如按时间分。
- 按哈希散列算法分（扩容的时候会很麻烦，不要用）。

#### 垂直分片

说白了就是拆表，把不同字段拆到不同的表里面，把经常修改的数据和不常修改的数据分离开。这样在修改某个字段的时候，不会导致其他字段的数据被锁。对于电商系统来说，商品的描述信息不常改，但是商品的库存和价格常改，所以可以把描述信息和库存价格拆成两张表，这样可以让商品描述信息的查询更快。

#### 数据库扩展的设计重点

对于分片来说，有两种分片模式，一种是水平分片，一种是垂直分片。水平分片(sharding)就是我们之前说的那种分片。而垂直分片是把一张表中的一些字段放到一张表中，另一些字段放到另一张表中。

垂直分片主要是把一些经常修改的数据和不经常修改的数据给分离开来，这样在修改某个字段的数据时，不会导致其它字段的数据被锁而影响性能。比如，对于电商系统来说，商品的描述信息不常改，但是商品的库存和价格经常改，所以，可以把描述信息和库存价格分成两张表，这样可以让商品的描述信息的查询更快。

水平分片(sharding)需要有以下一些注意事项。

随着数据库中数据的变化，我们有可能需要定期重新平衡分片，以保证均匀分布并降低形成热点的可能性。 但是，重新平衡是一项昂贵的操作。 若要减少重新平衡的频率，我们需要通过确保每个分片包含足够的可用空间来处理未来一段时间的变化。 另外，我们还需要开发用于快速重新平衡分片的工具和脚本。
分片是静态的，而数据的访问则是不可预期的，可能需要经常性地调整我们的分片，这样一来成本太高。所以，我们最好使用一个索引表的方式来进行分片。也就是说，把我们数据的索引动态地记录在一个索引表中。这样一来，我们就可以非常灵活地调度我们的数据了。当数据调度到另一台结点上时，我们只需要去索引表里改一下这个数据的位置就好了。

如果程序必须要从多个分片检索数据的查询，则可以使用并行任务从各个分片上提取此数据，然后聚合到单个结果中。 但是，此方法不可避免地会在一定程度上增加解决方案数据访问逻辑的复杂性。
数据分片后，我们很难在分片之间保持引用完整性和一致性，也就是所谓的跨分片的事务，因此应尽量减少会影响多个分片中的数据的操作。如果应用程序必须跨分片修改数据，那么我们需要评估一致性以及评估是否采用两阶段提交的方式。

配置和管理大量分片可能是一个挑战。在做相应的变更时，一定要先从生产线上拉出数据，然后根据数据计划好新的分片方式，并做好相当的测试工作。否则，这个事出了问题会是一个灾难性的问题。
